// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  FREE_USER
  BASIC
  PREMIUM
  INSTITUTIONAL
  ADMIN
  MODERATOR
  SUPPORT
  SUPER_ADMIN
}

enum PropertyStatus {
  LISTED
  FULLY_SUBSCRIBED
  CLOSED
  DELISTED
}

enum TransactionType {
  OWNERSHIP_REGISTRATION
  DISTRIBUTION
  TRANSFER_REQUEST
  WALLET_DEPOSIT
  WALLET_WITHDRAWAL
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum TransferStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
  CANCELLED
}

model User {
  id                    String    @id @default(uuid())
  email                 String    @unique
  password              String
  firstName             String
  lastName              String
  phone                 String?
  role                  UserRole  @default(FREE_USER)
  tier                  String    @default("free")
  isVerified            Boolean   @default(false)
  kycStatus             String?   @default("not_submitted")
  
  // Security fields
  failedLoginAttempts   Int       @default(0)
  lockedUntil           DateTime?
  twoFactorSecret       String?
  twoFactorEnabled      Boolean   @default(false)
  lastLogin             DateTime?
  
  // OAuth fields
  googleId              String?   @unique
  appleId               String?   @unique
  
  // Financial
  walletBalance         Decimal   @default(0) @db.Decimal(15, 2)
  
  // Soft delete
  deletedAt             DateTime?
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  ownerships            Ownership[]
  transactions          Transaction[]
  notifications         Notification[]
  documents             Document[]
  supportTickets        SupportTicket[]
  kycRecords            KYCRecord[]
  transferRequests      TransferRequest[]
  adminAuditLogs        AdminAuditLog[]
  paymentProofs         PaymentProof[]
  adminInvitationsCreated AdminInvitation[] @relation("AdminCreator")

  @@index([email])
  @@index([role])
}

model Property {
  id                    String         @id @default(uuid())
  name                  String
  description           String?
  location              String
  address               String?
  propertyType          String
  totalValue            Decimal        @db.Decimal(15, 2)
  pricePerUnit          Decimal        @db.Decimal(15, 2)
  totalUnits            Int
  availableUnits        Int
  size                  String?
  bedrooms              Int?
  bathrooms             Int?
  expectedAnnualIncome  Decimal?       @db.Decimal(15, 2)
  status                PropertyStatus @default(LISTED)
  isFeatured            Boolean        @default(false)
  
  images                String[]
  documents             String[]
  titleDeedUrl          String?
  certificateUrl        String?
  
  listedAt              DateTime       @default(now())
  lastDistributionDate  DateTime?
  
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  // Relations
  ownerships            Ownership[]
  transactions          Transaction[]
  distributions         Distribution[]
  transferRequests      TransferRequest[]
  paymentProofs         PaymentProof[]

  @@index([status])
  @@index([propertyType])
}

model Ownership {
  id                String    @id @default(uuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id])
  propertyId        String
  property          Property  @relation(fields: [propertyId], references: [id])
  units             Int
  acquisitionPrice  Decimal   @db.Decimal(15, 2)
  acquisitionDate   DateTime
  currentValue      Decimal?  @db.Decimal(15, 2)
  status            String    @default("ACTIVE")
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([userId, propertyId])
  @@index([userId])
  @@index([propertyId])
}

model Transaction {
  id                String            @id @default(uuid())
  userId            String
  user              User              @relation(fields: [userId], references: [id])
  propertyId        String?
  property          Property?         @relation(fields: [propertyId], references: [id])
  type              TransactionType
  amount            Decimal           @db.Decimal(15, 2)
  fee               Decimal           @default(0) @db.Decimal(15, 2)
  status            TransactionStatus
  paymentMethod     String?
  paymentReference  String?
  description       String?
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([userId])
  @@index([propertyId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model Distribution {
  id                String   @id @default(uuid())
  propertyId        String
  property          Property @relation(fields: [propertyId], references: [id])
  amount            Decimal  @db.Decimal(15, 2)
  distributionDate  DateTime
  period            String
  description       String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([propertyId])
  @@index([distributionDate])
}

model TransferRequest {
  id                    String         @id @default(uuid())
  userId                String
  user                  User           @relation(fields: [userId], references: [id])
  ownershipId           String?
  propertyId            String?
  property              Property?      @relation(fields: [propertyId], references: [id])
  units                 Int
  requestedPrice        Decimal?       @db.Decimal(15, 2)
  status                TransferStatus @default(PENDING)
  reason                String?
  
  // Encrypted bank details
  bankName              String?
  bankAccountNumber     String?  // Will be encrypted
  bankAccountName       String?
  
  reviewedBy            String?
  reviewedAt            DateTime?
  rejectionReason       String?
  
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  @@index([userId])
  @@index([status])
}

model PaymentProof {
  id                String   @id @default(uuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id])
  propertyId        String
  property          Property @relation(fields: [propertyId], references: [id])
  units             Int
  amount            Decimal  @db.Decimal(15, 2)
  paymentMethod     String   // 'bank_transfer' | 'card'
  
  // Bank transfer details
  depositorName     String?
  transferDate      DateTime?
  transferReference String?
  transferReceipt   String?  // Encrypted file path
  
  // Admin verification
  status            String   @default("pending") // pending, verified, rejected
  verifiedBy        String?
  verifiedAt        DateTime?
  rejectionReason   String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

model Notification {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  title       String
  message     String
  type        String   // 'info', 'success', 'warning', 'error'
  isRead      Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([isRead])
}

model Document {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  name        String
  type        String
  url         String
  size        Int?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

model SupportTicket {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  subject     String
  message     String
  status      String   @default("open")
  priority    String   @default("medium")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

model KYCRecord {
  id                String   @id @default(uuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id])
  status            String   @default("pending")
  
  // Personal Info
  dateOfBirth       DateTime?
  nationality       String?
  address           String?
  city              String?
  state             String?
  postalCode        String?
  
  // ID Verification
  idType            String?
  idNumber          String?
  idFrontUrl        String?
  idBackUrl         String?
  
  // Proof of Address
  proofOfAddressUrl String?
  
  // Review
  reviewedBy        String?
  reviewedAt        DateTime?
  rejectionReason   String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

model AdminAuditLog {
  id          String   @id @default(uuid())
  adminId     String
  admin       User     @relation(fields: [adminId], references: [id])
  action      String
  targetType  String?
  targetId    String?
  details     String?
  ipAddress   String?
  
  createdAt   DateTime @default(now())

  @@index([adminId])
  @@index([createdAt])
}

model AdminInvitation {
  id          String   @id @default(uuid())
  email       String   @unique
  role        String
  permissions String[]
  token       String   @unique
  used        Boolean  @default(false)
  createdBy   String
  creator     User     @relation("AdminCreator", fields: [createdBy], references: [id])
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  @@index([token])
  @@index([email])
}
