// This is your Prisma schema file
// Complete fix for all TypeScript compilation errors

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ENUMS
enum UserRole {
  USER
  FREE_USER
  BASIC
  PREMIUM
  INSTITUTIONAL
  ADMIN
  MODERATOR
  SUPPORT
  SUPER_ADMIN
}

enum PropertyStatus {
  LISTED
  FULLY_SUBSCRIBED
  CLOSED
  DELISTED
}

enum TransactionType {
  OWNERSHIP_REGISTRATION
  DISTRIBUTION
  TRANSFER_REQUEST
  WALLET_DEPOSIT
  WALLET_WITHDRAWAL
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum TransferStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
  CANCELLED
  PROCESSING  // Added for withdrawalLimits controller
}

enum KYCStatus {
  NOT_SUBMITTED
  PENDING
  SUBMITTED
  VERIFIED
  REJECTED
}

// MODELS
model User {
  id                    String    @id @default(uuid())
  email                 String    @unique
  password              String
  firstName             String
  lastName              String
  phone                 String?
  role                  UserRole  @default(FREE_USER)
  tier                  String    @default("free")
  isVerified            Boolean   @default(false)
  kycStatus             String?   @default("not_submitted")
  
  // Security fields
  failedLoginAttempts   Int       @default(0)
  lockedUntil           DateTime?
  twoFactorSecret       String?
  twoFactorEnabled      Boolean   @default(false)
  lastLogin             DateTime?
  
  // OAuth fields
  googleId              String?   @unique
  appleId               String?   @unique
  
  // Financial
  walletBalance         Decimal   @default(0) @db.Decimal(15, 2)
  
  // Soft delete
  deletedAt             DateTime?
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  ownerships              Ownership[]
  transactions            Transaction[]
  notifications           Notification[]
  documents               Document[]
  supportTickets          SupportTicket[]
  kycRecords              KYCRecord[]  // Relation to KYC model
  transferRequests        TransferRequest[]
  adminAuditLogs          AdminAuditLog[]
  paymentProofs           PaymentProof[]
  adminInvitationsCreated AdminInvitation[] @relation("AdminCreator")
  auditLogs               AuditLog[]  // Added for dataRetention util

  @@index([email])
  @@index([role])
}

model Property {
  id                String          @id @default(uuid())
  name              String
  description       String
  address           String
  city              String
  state             String
  country           String          @default("Nigeria")
  totalUnits        Int
  availableUnits    Int
  pricePerUnit      Decimal         @db.Decimal(15, 2)
  totalValue        Decimal         @db.Decimal(15, 2)
  expectedReturn    Decimal         @db.Decimal(5, 2)
  status            PropertyStatus  @default(LISTED)
  images            String[]
  documents         String[]
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relations
  ownerships        Ownership[]
  transactions      Transaction[]
  transferRequests  TransferRequest[]

  @@index([status])
  @@index([city])
}

model Ownership {
  id                String   @id @default(uuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id])
  propertyId        String
  property          Property @relation(fields: [propertyId], references: [id])
  units             Int
  acquisitionPrice  Decimal  @db.Decimal(15, 2)
  acquisitionDate   DateTime @default(now())  // Added for ownership controller
  currentValue      Decimal  @db.Decimal(15, 2)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  transactions      Transaction[]
  transferRequests  TransferRequest[] @relation("OwnershipTransfers")  // Added for transfer controllers

  @@index([userId])
  @@index([propertyId])
  @@unique([userId, propertyId])
}

model Transaction {
  id            String            @id @default(uuid())
  userId        String
  user          User              @relation(fields: [userId], references: [id])
  propertyId    String?
  property      Property?         @relation(fields: [propertyId], references: [id])
  ownershipId   String?
  ownership     Ownership?        @relation(fields: [ownershipId], references: [id])
  type          TransactionType
  amount        Decimal           @db.Decimal(15, 2)
  status        TransactionStatus @default(PENDING)
  reference     String            @unique
  description   String?
  
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model TransferRequest {
  id                String         @id @default(uuid())
  userId            String
  user              User           @relation(fields: [userId], references: [id])
  propertyId        String?
  property          Property?      @relation(fields: [propertyId], references: [id])
  ownershipId       String?
  ownership         Ownership?     @relation("OwnershipTransfers", fields: [ownershipId], references: [id])  // Added relation
  units             Int
  status            TransferStatus @default(PENDING)
  amount            Decimal?       @db.Decimal(15, 2)  // Added for withdrawal controllers
  bankName          String?
  bankAccountNumber String?
  bankAccountName   String?
  accountNumber     String?        // Legacy field - maps to bankAccountNumber
  reason            String?
  requestType       String?        @default("transfer")
  rejectionReason   String?
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  title     String
  message   String
  type      String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

model Document {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  filename    String
  url         String
  type        String
  size        Int
  uploadedAt  DateTime @default(now())

  @@index([userId])
}

model SupportTicket {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  subject     String
  message     String
  category    String?  // Added for support routes
  status      String   @default("open")
  priority    String   @default("medium")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

model KYCRecord {
  id              String     @id @default(uuid())
  userId          String
  user            User       @relation(fields: [userId], references: [id])
  status          KYCStatus  @default(NOT_SUBMITTED)
  idType          String?
  idNumber        String?
  idDocument      String?
  proofOfAddress  String?
  bvn             String?
  submittedAt     DateTime?
  reviewedAt      DateTime?
  reviewedBy      String?
  rejectionReason String?
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@index([userId])
  @@index([status])
}

model PaymentProof {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  propertyId      String?
  amount          Decimal  @db.Decimal(15, 2)
  paymentMethod   String
  receiptUrl      String
  status          String   @default("pending")
  verifiedBy      String?
  verifiedAt      DateTime?
  rejectionReason String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

model AdminAuditLog {
  id          String   @id @default(uuid())
  adminId     String
  admin       User     @relation(fields: [adminId], references: [id])
  action      String
  entityType  String?  // Added for admin controller
  targetType  String?
  targetId    String?
  details     String?
  ipAddress   String?
  
  createdAt   DateTime @default(now())

  @@index([adminId])
  @@index([createdAt])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  action    String
  resource  String
  details   Json?
  ipAddress String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

model AdminInvitation {
  id          String   @id @default(uuid())
  email       String   @unique
  role        String
  permissions String[]
  token       String   @unique
  used        Boolean  @default(false)
  createdBy   String
  creator     User     @relation("AdminCreator", fields: [createdBy], references: [id])
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  @@index([token])
  @@index([email])
}
